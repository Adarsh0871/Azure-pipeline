trigger:
  - main  # Runs the pipeline when changes are pushed to 'main' branch

pool:
  name: Default  # Use your self-hosted agent pool name

stages:
- stage: Build
  jobs:
  - job: BuildJob
    steps:
    - script: |
        echo "Building HTML site..."
        mkdir -p $(Build.ArtifactStagingDirectory)/site
        cp -r * $(Build.ArtifactStagingDirectory)/site
      displayName: "Prepare HTML Artifacts"

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/site'
        artifactName: 'html-site'

- stage: Deploy
  jobs:
  - job: DeployToLocalServer
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        artifactName: 'html-site'
        downloadPath: '$(Build.ArtifactStagingDirectory)'

    - task: CopyFilesOverSSH@0
      inputs:
        sshEndpoint: 'pipeline_test'  # Must match the service connection name
        sourceFolder: '$(Build.ArtifactStagingDirectory)/html-site'
        targetFolder: '/var/www/html'
        cleanTargetFolder: true
        overwrite: true
      displayName: "Copy HTML Files to Local Server"

    - task: SSH@0
      inputs:
        sshEndpoint: 'pipeline_test'
        runOptions: 'inline'
        inline: |
          echo "Restarting Apache on Local Server..."
          sudo systemctl restart apache2
      displayName: "Restart Web Server"
